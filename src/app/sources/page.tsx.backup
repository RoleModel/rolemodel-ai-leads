"use client"

import { useState, useEffect } from "react"
import { TopBar } from "@/components/layout/TopBar"
import { NavigationSidebar } from "@/components/layout/NavigationSidebar"
import { Add01Icon, Delete02Icon } from "hugeicons-react"

interface Source {
  id: string
  title: string | null
  content: string
  created_at: string
}

export default function SourcesPage() {
  const [sources, setSources] = useState<Source[]>([])
  const [isLoading, setIsLoading] = useState(true)
  const [isAdding, setIsAdding] = useState(false)
  const [newTitle, setNewTitle] = useState("")
  const [newContent, setNewContent] = useState("")

  useEffect(() => {
    loadSources()
  }, [])

  async function loadSources() {
    try {
      const res = await fetch('/api/sources')
      const data = await res.json()
      setSources(data.sources || [])
    } catch (error) {
      console.error('Error loading sources:', error)
    } finally {
      setIsLoading(false)
    }
  }

  async function handleAddSource() {
    if (!newContent.trim()) return

    setIsAdding(true)
    try {
      const res = await fetch('/api/sources', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          title: newTitle.trim() || null,
          content: newContent.trim(),
        }),
      })

      if (res.ok) {
        setNewTitle("")
        setNewContent("")
        await loadSources()
      }
    } catch (error) {
      console.error('Error adding source:', error)
    } finally {
      setIsAdding(false)
    }
  }

  async function handleDeleteSource(id: string) {
    if (!confirm('Are you sure you want to delete this source?')) return

    try {
      await fetch(`/api/sources?id=${id}`, { method: 'DELETE' })
      await loadSources()
    } catch (error) {
      console.error('Error deleting source:', error)
    }
  }

  return (
    <div style={{ display: 'flex', flexDirection: 'column', height: '100vh' }}>
      <TopBar />

      <div style={{ flex: 1, display: 'flex', overflow: 'hidden' }}>
        <NavigationSidebar />

        <main style={{
          flex: 1,
          display: 'flex',
          flexDirection: 'column',
          overflow: 'auto',
          padding: 'var(--op-space-large)',
        }}>
          <div style={{ marginBottom: 'var(--op-space-large)' }}>
            <h1 style={{
              fontSize: 'var(--op-font-x-large)',
              fontWeight: 'var(--op-font-weight-bold)',
              margin: 0,
            }}>
              Sources
            </h1>
            <p style={{
              fontSize: 'var(--op-font-small)',
              color: 'var(--op-color-neutral-on-plus-max)',
              margin: 'var(--op-space-2x-small) 0 0 0',
            }}>
              Add training data to make your chatbot smarter
            </p>
          </div>

          {/* Add New Source */}
          <div className="card" style={{ marginBottom: 'var(--op-space-large)' }}>
            <div className="card-header">
              <h2 style={{ fontSize: 'var(--op-font-medium)', margin: 0 }}>
                Add New Source
              </h2>
            </div>
            <div className="card-body" style={{ display: 'flex', flexDirection: 'column', gap: 'var(--op-space-medium)' }}>
              <div className="form-group">
                <label htmlFor="source-title" className="form-label">Title (optional)</label>
                <input
                  id="source-title"
                  className="form-control form-control--large"
                  value={newTitle}
                  onChange={(e) => setNewTitle(e.target.value)}
                  placeholder="e.g., Services Overview"
                />
              </div>

              <div className="form-group">
                <label htmlFor="source-content" className="form-label">Content</label>
                <textarea
                  id="source-content"
                  className="form-control"
                  value={newContent}
                  onChange={(e) => setNewContent(e.target.value)}
                  placeholder="Enter the text content that the chatbot should learn from..."
                  rows={8}
                  style={{ resize: 'vertical' }}
                  required
                  aria-required="true"
                />
              </div>

              <button
                className="btn btn--primary btn--large"
                onClick={handleAddSource}
                disabled={isAdding || !newContent.trim()}
                style={{ alignSelf: 'flex-start' }}
              >
                <Add01Icon className="icon-sm" />
                {isAdding ? 'Adding...' : 'Add Source'}
              </button>
            </div>
          </div>

          {/* Sources List */}
          <div>
            <h2 style={{
              fontSize: 'var(--op-font-large)',
              fontWeight: 'var(--op-font-weight-bold)',
              marginBottom: 'var(--op-space-medium)',
            }}>
              Existing Sources ({sources.length})
            </h2>

            {isLoading ? (
              <p style={{ color: 'var(--op-color-neutral-on-plus-max)' }}>Loading...</p>
            ) : sources.length === 0 ? (
              <p style={{ color: 'var(--op-color-neutral-on-plus-max)' }}>
                No sources yet. Add your first source above to get started.
              </p>
            ) : (
              <div style={{ display: 'flex', flexDirection: 'column', gap: 'var(--op-space-medium)' }}>
                {sources.map((source) => (
                  <div key={source.id} className="card">
                    <div className="card-header" style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                      <h3 style={{ fontSize: 'var(--op-font-medium)', margin: 0 }}>
                        {source.title || 'Untitled Source'}
                      </h3>
                      <button
                        className="btn btn--destructive btn--small btn--icon"
                        onClick={() => handleDeleteSource(source.id)}
                        title="Delete source"
                      >
                        <Delete02Icon className="icon-sm" />
                      </button>
                    </div>
                    <div className="card-body">
                      <p style={{
                        fontSize: 'var(--op-font-small)',
                        whiteSpace: 'pre-wrap',
                        margin: 0,
                        maxHeight: '200px',
                        overflow: 'auto',
                      }}>
                        {source.content}
                      </p>
                      <p style={{
                        fontSize: 'var(--op-font-x-small)',
                        color: 'var(--op-color-neutral-on-plus-max)',
                        marginTop: 'var(--op-space-small)',
                      }}>
                        Added {new Date(source.created_at).toLocaleDateString()}
                      </p>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
        </main>
      </div>
    </div>
  )
}
